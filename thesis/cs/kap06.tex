\chapter{Vyhodnocení práce}

Výsledkem této práce je implementace systému pro porovnávání výkonu verzí softwaru
pojmenovaná PerfEval. V této kapitole bude krok za krokem ukázáno, jak se systémem pracovat.

\section{Používání systému PerfEval}

V~následujících dvou ukázkách bude vysvětleno, jak používat PerfEval. První ukázka bude
cílit na~nastínění, co~nejjednoduššího použití. Druhá část ukáže aplikaci PerfEvalu na~skutečným projektu.

\subsection*{Jednoduché použití PerfEvalu}

Následující kód popisuje obvyklou posloupnost příkazů práce se systémem PerfEval.
Na začátku je nutné jej inicializovat. PerfEval bude inicializován pro použití JMHJSONParseru.
Následně se přidají výsledky měření několika (alespoň dvou) různých verzí.
Nakonec program vypíše, jestli výkonnostní testy prošly nebo ne.

\begin{lstlisting}
    perfeval init --benchmark-parser JMHJSONParser
    perfeval index-all-results --path tests/old_test --version old_version
    perfeval index-all-results --path tests/new_test --version new_version
    perfeval evaluate && echo "Performance test passed" | exit 0
    echo "Performance test failed" | exit 1
\end{lstlisting}

\subsection*{Návrh skriptu pro doměření výsledků}

Následující kód nastiňuje možnost využití příkazu list-undecided. Výstupem tohoto příkazu
jsou dva tabulátorem oddělené sloupce. V prvním sloupci jsou názvy metod, pro něž systém
eviduje málo naměřených běhů. Ve druhém sloupci je uveden tento počet. Příkaz je určený
pro skriptování, proto není dodaná žádná další hlavička.

V případě, že výstupem není žádný výpis, tak je hodnot u všech testovacích metod naměřeno dostatek. Druhou alternativou
je, že v důsledku nastavení v~konfiguračním souboru systém vyhodnotil, že není možné požadovaný
počet testů doměřit. Následné vyhodnocení pak bude vyžadovat kontrolu uživatelem, protože
systém PerfEval bude vyhodnocení považovat za nevyhovující.

Skript projde všechny řádky výpisu. Pokud je výpis prázdný, tak skončí.
V~následujícím kódu je celá situace velmi zjednodušena. Nalezene se maximální počet
testů, který je zapotřebí změřit. Pro~tento maximální počet se změří výkony obou verzí znovu. Výsledky těchto měření
se zaznamenají do~systému PerfEval. Po~doběhnutí všech měření skript skončí. Vyhodnotí mezi sebou výsledky těchto
verzí a~skončí. Parametry \$1 a~\$2 jsou stará a~nová verze k~porovnání. Předpokládá se, že
příkaz measure provede měření verze zadané jako první argument a~výsledek uloží do souboru specifikovaného jako druhý argument.

\begin{lstlisting}
    #!/bin/bash

    index=1
    while true; do
        output=$(perfeval list-undecided --old-version "$1" --new-version "$2")
        if [[ -n "$output" ]]; then
            max=$(echo "$output" | cut -f2 -d$'\t' | sort -n -k | head 1)
            for ((i=1; i<=$max; i++)); do
                result_file="old_version_$index"
                measure "$1" "$result_file"
                perfeval index-new-result --path "$result_file" --version "$1"

                result_file="new_version_$index"
                measure "$2" "$result_file"
                perfeval index-new-result --path "$result_file" --version "$2"
                ((index++))
            done
        else
            perfeval evaluate --old-version "$1" --new-version "$2"
            exit $?
            break
        fi
    done

\end{lstlisting}

\section{Nasazení systému v praxi}

V~této kapitole bude ukázáno, jak systém PerfEval funguje při~svém nasazení.
Pro ukázku byl vybrán projekt Crate \cite{crateDB}. Jedná se~o~databázový projekt
volně dostupný na platformě GitHub.

Projekt Crate byl vybrán, protože je volně dostupný, a~protože má implementované výkonnostní testy.
Tyto testy je možné spouštět samostatně přímo z~adresáře projektu a~to~i~pro~starší verze.

Systém PerfEval tedy bude použit pro porovnání vybraných commitů. Cílem tohoto
spouštění je zjistit, jestli systém PerfEval detekuje zhoršení a~případně zlepšení
výkonu.

\subsection{Výběr commitů}

Commity pro prezentování práce systému byly vybírány z~období od~21.~dubna 2020 do~11.~května 2023.
Byly vybrány ty commity, jejichž commit message obsahuje slovo „performance“ a~jejich sousední commity (pro porovnání).
Commity byly vybírány z~hlavní větve projektu. Všechny výkonnostní testy byly prováděné na~strojích stejného druhu a~konfigurace.

Z takto vybraných commitů byly dále vybrané jen ty, u~kterých bylo možné projekt bez problémů sestavit. Zároveň bylo také nutné,
aby bylo možné sestavit a~spustit výkonnostní testy. Nakonec tedy bylo vybráno a~naměřeno celkem 16 commitů z~uvedeného období.
Pro každý z~těchto commitů, který reprezentuje v~doméně systému PerfEval verzi, bylo měření provedeno celkem osmkrát.

\subsection{Porovnatelné commity}

Systém PerfEval porovnává pouze dvě verze jejichž všechny testované metody se shodují. Pokud se tedy mezi dvěma
verzemi název některé metody změnil, byla přidaná nová metoda nebo byla nějaká metoda odstraněna, tak tyto verze
PerfEval neporovná.

Proto i ze zvolených 16 commitů nebylo možné porovnat každý s každým. Naměřené commity se tedy rozdělily do tří skupin.
V těchto skupinách se všechny měřené metody shodují, a tak je možné je vzájemně porovnat. Zároveň se v commitu
označeném jako HEAD, tedy nejnovější verze, přidala jedna nová metoda, a tak není možné jej porovnávat s žádným jiným commitem.

V první skupině se nachází 3 commity z období od 8. června 2022 do 4. července 2022.
Ve druhé skupině se nachází 3 commity z období od 28. února 2023 do 7. března 2023.
V poslední skupině se nachází 9 commitů z období od 29. března 2023 do 11. května 2023.
U nejnovějšího commitu z 11. května 2023 (čas 15:42:16) je součástí commit message také poznámka o tom,
že byla přidaná nová testovací metoda v rámci benchmarku JMH.

\subsection{Výsledek práce systému PerfEval}
